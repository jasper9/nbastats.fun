<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev Live Feed - NBA Stats Fun</title>
    {% if ga_tracking_id %}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ ga_tracking_id }}"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '{{ ga_tracking_id }}');
    </script>
    {% endif %}
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23f85' stroke='%23333' stroke-width='3'/><path d='M50 5 v90 M5 50 h90 M15 20 Q50 50 15 80 M85 20 Q50 50 85 80' fill='none' stroke='%23333' stroke-width='3'/></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap');
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-card: #1c2128;
            --border: #30363d;
            --text-primary: #ffffff;
            --text-secondary: #b0b8c1;
            --text-muted: #6b7280;
            --nuggets-gold: #fec524;
            --nuggets-navy: #0d2240;
            --positive: #34d399;
            --negative: #f87171;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }
        /* Navigation */
        nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
        }
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .nav-brand {
            font-family: 'Oswald', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--nuggets-gold);
            text-decoration: none;
            padding: 15px 0;
        }
        .nav-links {
            display: flex;
            gap: 5px;
        }
        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 15px 15px;
            font-size: 0.9rem;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        .nav-links a:hover { color: var(--text-primary); }
        .nav-links a.active {
            color: var(--nuggets-gold);
            border-bottom-color: var(--nuggets-gold);
        }
        /* Live nav link styling */
        .nav-live {
            position: relative;
        }
        .nav-live:not(.is-live) {
            text-decoration: line-through;
            opacity: 0.5;
        }
        .nav-live.is-live {
            color: #ef4444 !important;
            font-weight: 600;
        }
        .nav-live.is-live::before {
            content: '';
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse-live 1.5s ease-in-out infinite;
        }
        @keyframes pulse-live {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { opacity: 0.8; box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
        }
        /* Header */
        header {
            background: linear-gradient(135deg, var(--nuggets-navy) 0%, #1a3a5c 100%);
            text-align: center;
            padding: 12px 20px;
            border-bottom: 3px solid var(--nuggets-gold);
        }
        .page-title {
            font-family: 'Oswald', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-primary);
        }
        .page-subtitle {
            color: var(--nuggets-gold);
            font-size: 0.8rem;
            margin-top: 3px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 15px;
        }
        /* Game Selector */
        .game-selector {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .game-selector label {
            color: var(--text-muted);
            font-size: 0.85rem;
            display: block;
            margin-bottom: 8px;
        }
        .game-selector select {
            width: 100%;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
        }
        .game-selector select:focus {
            outline: none;
            border-color: var(--nuggets-gold);
        }
        /* Scoreboard */
        .scoreboard {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
        }
        .team-score {
            text-align: center;
        }
        .team-abbrev {
            font-family: 'Oswald', sans-serif;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }
        .team-points {
            font-family: 'Oswald', sans-serif;
            font-size: 3rem;
            font-weight: 700;
        }
        .score-divider {
            font-size: 2rem;
            color: var(--text-muted);
        }
        /* Odds Display */
        .odds-section {
            display: none;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .odds-section.visible {
            display: block;
        }
        .odds-row {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 25px;
            flex-wrap: wrap;
        }
        .odds-item {
            text-align: center;
        }
        .odds-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .odds-value {
            font-family: 'Oswald', sans-serif;
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        .odds-value .team-abbrev {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-right: 4px;
        }
        .odds-moneyline {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .ml-team {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 50px;
        }
        .ml-abbrev {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .ml-value {
            font-family: 'Oswald', sans-serif;
            font-size: 1rem;
        }
        .ml-value.favorite {
            color: var(--positive);
        }
        .ml-value.underdog {
            color: var(--text-secondary);
        }
        /* Win Probability Bar */
        .prob-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 200px;
        }
        .prob-bar-container {
            width: 100%;
            height: 24px;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            position: relative;
        }
        .prob-bar {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Oswald', sans-serif;
            font-size: 0.75rem;
            color: var(--bg-primary);
            font-weight: 600;
            min-width: 40px;
        }
        .prob-bar.away {
            border-radius: 12px 0 0 12px;
        }
        .prob-bar.home {
            border-radius: 0 12px 12px 0;
        }
        .prob-labels {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 4px;
        }
        .prob-label {
            font-family: 'Oswald', sans-serif;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .prob-label .team-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .odds-vendor-count {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 8px;
        }
        /* Mini Charts */
        .mini-charts {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .mini-charts.visible {
            display: grid;
        }
        .mini-chart {
            background: var(--bg-secondary);
            border-radius: 6px;
            padding: 10px;
        }
        .mini-chart-title {
            font-family: 'Oswald', sans-serif;
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        .mini-chart-container {
            height: 100px;
            position: relative;
        }
        @media (max-width: 600px) {
            .mini-charts {
                grid-template-columns: 1fr;
            }
            .mini-chart-container {
                height: 80px;
            }
        }
        /* Chat Feed */
        .chat-container {
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
        }
        .chat-header {
            background: var(--bg-card);
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-stats {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
        }
        .stat-item {
            color: var(--text-secondary);
            background: var(--bg-secondary);
            padding: 4px 10px;
            border-radius: 4px;
        }
        .stat-item#stat-score {
            color: var(--nuggets-gold);
            font-weight: 600;
        }
        .stat-item#stat-lead-changes {
            color: #f97316;
        }
        .stat-item#stat-viewers {
            color: var(--positive);
        }
        .chat-title {
            font-family: 'Oswald', sans-serif;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .chat-status {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .chat-status.connected {
            color: var(--positive);
        }
        .chat-feed {
            height: 500px;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        /* Chat Messages */
        .chat-message {
            display: flex;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-card);
            border-radius: 8px;
            animation: slideIn 0.3s ease-out;
            border-left: 3px solid var(--border);
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .chat-message.bot-play_by_play {
            border-left-color: #ffffff;
        }
        .chat-message.bot-stats_nerd {
            border-left-color: #22d3ee;
        }
        .chat-message.bot-odds_shark {
            border-left-color: #34d399;
        }
        .chat-message.bot-hype_man {
            border-left-color: #f97316;
        }
        .chat-message.bot-historian {
            border-left-color: #a855f7;
        }
        .chat-message.bot-ai_commentator {
            border-left-color: #60a5fa;
            background: linear-gradient(90deg, rgba(96, 165, 250, 0.1), var(--bg-card));
        }
        .msg-avatar {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .msg-content {
            flex: 1;
            min-width: 0;
        }
        .msg-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .msg-bot-name {
            font-weight: 600;
            font-size: 0.8rem;
        }
        .msg-bot-name.bot-play_by_play { color: #ffffff; }
        .msg-bot-name.bot-stats_nerd { color: #22d3ee; }
        .msg-bot-name.bot-odds_shark { color: #34d399; }
        .msg-bot-name.bot-hype_man { color: #f97316; }
        .msg-bot-name.bot-historian { color: #a855f7; }
        .msg-bot-name.bot-ai_commentator { color: #60a5fa; }
        .msg-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .msg-text {
            color: var(--text-primary);
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .msg-score {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        /* Team colors for messages */
        .team-MIN .msg-avatar { color: #78BE20; }
        .team-CLE .msg-avatar { color: #860038; }
        /* Footer */
        .footer {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-size: 0.8rem;
            border-top: 1px solid var(--border);
            margin-top: 40px;
        }
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--nuggets-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Bot Filters */
        .bot-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-top: 15px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 6px;
        }
        .filter-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-right: 5px;
        }
        .filter-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.5;
        }
        .filter-btn:hover {
            border-color: var(--btn-color);
        }
        .filter-btn.active {
            opacity: 1;
            color: var(--text-primary);
            border-color: var(--btn-color);
            background: rgba(255, 255, 255, 0.05);
        }
        .filter-btn .filter-dot {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            background: var(--btn-color);
            transition: opacity 0.2s;
        }
        .filter-btn:not(.active) .filter-dot {
            opacity: 0.3;
        }
        /* Hide filtered messages */
        .chat-message.filtered {
            display: none !important;
        }
        /* Box Score Section */
        .box-score-section {
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-top: 15px;
            overflow: hidden;
            display: none;
        }
        .box-score-section.visible {
            display: block;
        }
        .box-score-header {
            background: var(--bg-card);
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .box-score-title {
            font-family: 'Oswald', sans-serif;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }
        .team-toggle {
            display: flex;
            gap: 5px;
        }
        .team-toggle-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .team-toggle-btn:hover {
            border-color: var(--text-secondary);
        }
        .team-toggle-btn.active {
            background: var(--nuggets-gold);
            border-color: var(--nuggets-gold);
            color: #000;
        }
        .box-score-content {
            padding: 10px;
            overflow-x: auto;
        }
        .player-stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        .player-stats-table th {
            background: var(--bg-card);
            color: var(--text-secondary);
            font-weight: 500;
            padding: 8px 6px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            position: sticky;
            top: 0;
        }
        .player-stats-table th.player-col,
        .player-stats-table td.player-col {
            text-align: left;
            padding-left: 10px;
            min-width: 120px;
        }
        .player-stats-table td {
            padding: 8px 6px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }
        .player-stats-table td.player-col {
            color: var(--text-primary);
            font-weight: 500;
        }
        .player-stats-table tr:hover {
            background: rgba(255,255,255,0.03);
        }
        .player-stats-table tr.totals-row {
            background: var(--bg-card);
        }
        .player-stats-table tr.totals-row td {
            font-weight: 600;
            color: var(--text-primary);
            border-top: 2px solid var(--border);
        }
        .player-stats-table .highlight {
            color: var(--nuggets-gold);
            font-weight: 600;
        }
        .player-stats-table .pct {
            color: var(--text-muted);
            font-size: 0.75rem;
        }
        @media (max-width: 600px) {
            .page-title { font-size: 1.4rem; }
            .chat-feed { height: 400px; }
            .scoreboard { gap: 15px; }
            .team-points { font-size: 2.5rem; }
            .nav-links a { padding: 15px 10px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="/" class="nav-brand">NBA Stats . Fun</a>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/jokic">Jokic</a>
                <a href="/more">Nuggets</a>
                <a href="/live" class="nav-live {{ 'is-live' if is_game_live else '' }}">Live</a>
                <a href="/dev-live" class="active" style="color: #f97316;">Dev</a>
            </div>
        </div>
    </nav>

    <header>
        <div class="page-title">Live Play-by-Play Feed <span style="background: #f97316; color: white; font-size: 0.5em; padding: 3px 8px; border-radius: 4px; vertical-align: middle; margin-left: 10px;">DEV</span></div>
        <div class="page-subtitle">Real-time game updates with personality</div>
    </header>

    <div class="container">
        <div class="game-selector">
            <label>Select a live game: <span id="timezone-label" style="font-weight: normal; opacity: 0.7;"></span></label>
            <select id="game-select">
                <option value="">Loading games...</option>
            </select>
        </div>

        <div class="scoreboard" id="scoreboard" style="display: none;">
            <div class="team-score">
                <div class="team-abbrev" id="away-team">AWAY</div>
                <div class="team-points" id="away-score">0</div>
            </div>
            <div class="score-divider">@</div>
            <div class="team-score">
                <div class="team-abbrev" id="home-team">HOME</div>
                <div class="team-points" id="home-score">0</div>
            </div>
        </div>

        <div class="odds-section" id="odds-section">
            <div class="odds-row">
                <div class="odds-item">
                    <div class="odds-label">Spread</div>
                    <div class="odds-value" id="odds-spread">--</div>
                </div>
                <div class="odds-item">
                    <div class="odds-label">Total</div>
                    <div class="odds-value" id="odds-total">--</div>
                </div>
                <div class="odds-item">
                    <div class="odds-label">Moneyline</div>
                    <div class="odds-moneyline" id="odds-moneyline">
                        <div class="ml-team">
                            <span class="ml-abbrev" id="ml-away-abbrev">AWAY</span>
                            <span class="ml-value" id="ml-away-value">--</span>
                        </div>
                        <div class="ml-team">
                            <span class="ml-abbrev" id="ml-home-abbrev">HOME</span>
                            <span class="ml-value" id="ml-home-value">--</span>
                        </div>
                    </div>
                </div>
                <div class="odds-item prob-display">
                    <div class="odds-label">Win Probability</div>
                    <div class="prob-bar-container">
                        <div class="prob-bar away" id="away-prob-bar"></div>
                        <div class="prob-bar home" id="home-prob-bar"></div>
                    </div>
                    <div class="prob-labels">
                        <span class="prob-label" id="away-prob-label">
                            <span class="team-dot" id="away-dot"></span>
                            <span id="away-prob-text">AWAY 50%</span>
                        </span>
                        <span class="prob-label" id="home-prob-label">
                            <span id="home-prob-text">HOME 50%</span>
                            <span class="team-dot" id="home-dot"></span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="odds-vendor-count" id="odds-vendor-count"></div>
        </div>

        <div class="mini-charts" id="mini-charts">
            <div class="mini-chart">
                <div class="mini-chart-title">Lead Differential</div>
                <div class="mini-chart-container">
                    <canvas id="leadChart"></canvas>
                </div>
            </div>
            <div class="mini-chart">
                <div class="mini-chart-title">Win Probability</div>
                <div class="mini-chart-container">
                    <canvas id="probChart"></canvas>
                </div>
            </div>
        </div>

        <div class="chat-container" id="chat-container" style="display: none;">
            <div class="chat-header">
                <span class="chat-title">Live Feed</span>
                <div class="chat-stats">
                    <span class="stat-item" id="stat-score">0-0</span>
                    <span class="stat-item" id="stat-lead-changes">üîÑ 0</span>
                    <span class="stat-item" id="stat-viewers">üëÅ 1</span>
                </div>
            </div>
            <div class="chat-feed" id="chat-feed">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Waiting for game updates...</p>
                </div>
            </div>
        </div>

        <div class="bot-filters">
            <span class="filter-label">Filter voices:</span>
            <button class="filter-btn active" data-bot="play_by_play" style="--btn-color: #ffffff;">
                <span class="filter-dot"></span>
                PlayByPlay
            </button>
            <button class="filter-btn active" data-bot="stats_nerd" style="--btn-color: #22d3ee;">
                <span class="filter-dot"></span>
                StatsNerd
            </button>
            <button class="filter-btn active" data-bot="hype_man" style="--btn-color: #f97316;">
                <span class="filter-dot"></span>
                HypeMan
            </button>
            <button class="filter-btn active" data-bot="historian" style="--btn-color: #a855f7;">
                <span class="filter-dot"></span>
                Historian
            </button>
            <button class="filter-btn active" data-bot="ai_commentator" style="--btn-color: #60a5fa;">
                <span class="filter-dot"></span>
                AI
            </button>
        </div>

        <!-- Box Score Section -->
        <div class="box-score-section" id="box-score-section">
            <div class="box-score-header">
                <span class="box-score-title">Box Score</span>
                <div class="team-toggle">
                    <button class="team-toggle-btn active" id="toggle-away" data-team="away">Away</button>
                    <button class="team-toggle-btn" id="toggle-home" data-team="home">Home</button>
                </div>
            </div>
            <div class="box-score-content">
                <table class="player-stats-table">
                    <thead>
                        <tr>
                            <th class="player-col">Player</th>
                            <th>PTS</th>
                            <th>REB</th>
                            <th>AST</th>
                            <th>STL</th>
                            <th>BLK</th>
                            <th>FGM</th>
                            <th>FGA</th>
                            <th>FG%</th>
                            <th>3PM</th>
                            <th>FTM</th>
                            <th>FTA</th>
                        </tr>
                    </thead>
                    <tbody id="player-stats-body">
                        <!-- Player rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Development feature - Live play-by-play from NBA API</p>
    </div>

    <script>
        // Bot emoji mapping
        const botEmojis = {
            'play_by_play': '&#x1F3C0;',
            'stats_nerd': '&#x1F4CA;',
            'odds_shark': '&#x1F3B0;',
            'hype_man': '&#x1F525;',
            'historian': '&#x1F4DC;',
            'ai_commentator': '&#x1F916;'
        };

        const botNames = {
            'play_by_play': 'PlayByPlay',
            'stats_nerd': 'StatsNerd',
            'odds_shark': 'OddsShark',
            'hype_man': 'HypeMan',
            'historian': 'Historian',
            'ai_commentator': 'AI'
        };

        let currentGameId = null;
        let lastActionNumber = 0;
        let pollInterval = null;
        let clientId = 'client_' + Math.random().toString(36).substr(2, 9);

        // Current team names for chart labels
        let currentHomeTeam = 'HOME';
        let currentAwayTeam = 'AWAY';

        // Chart instances and data
        let leadChart = null;
        let probChart = null;
        let chartData = {
            labels: [],
            homeScores: [],
            awayScores: [],
            leadDiffs: [],  // positive = home leading
            homeProbs: [],  // home team win probability (0-100)
            quarterMarkers: [],  // indices where quarters start
            quarterLabels: []    // labels for quarter markers (Q1, Q2, etc.)
        };
        let lastPeriod = 0;  // Track current period for quarter markers

        // Player stats data
        let playerStats = { home: [], away: [] };
        let currentStatsTeam = 'away';  // Currently displayed team

        // Custom Chart.js plugin to draw vertical quarter lines
        const quarterLinesPlugin = {
            id: 'quarterLines',
            afterDraw: (chart) => {
                const ctx = chart.ctx;
                const xAxis = chart.scales.x;
                const yAxis = chart.scales.y;

                if (!chartData.quarterMarkers.length) return;

                ctx.save();
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1;
                ctx.setLineDash([3, 3]);

                chartData.quarterMarkers.forEach((index, i) => {
                    // Skip if index is out of bounds
                    if (index < 0 || index >= chartData.labels.length) return;

                    const x = xAxis.getPixelForValue(index);

                    ctx.beginPath();
                    ctx.moveTo(x, yAxis.top);
                    ctx.lineTo(x, yAxis.bottom);
                    ctx.stroke();

                    // Draw quarter label at top
                    if (chartData.quarterLabels[i]) {
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                        ctx.font = '8px Oswald';
                        ctx.textAlign = 'center';
                        ctx.fillText(chartData.quarterLabels[i], x, yAxis.top - 2);
                    }
                });

                ctx.restore();
            }
        };

        // Register the plugin globally
        Chart.register(quarterLinesPlugin);

        // Current game odds
        let currentOdds = null;

        // Store games for accessing odds when selecting
        let gamesData = {};

        // NBA team colors (primary and secondary)
        const teamColors = {
            'MIN': '#78BE20', 'CLE': '#860038', 'BOS': '#007A33', 'MIA': '#98002E',
            'IND': '#002D62', 'LAC': '#C8102E', 'DET': '#C8102E', 'SAS': '#C4CED4',
            'DAL': '#00538C', 'CHI': '#CE1141', 'CHA': '#1D1160', 'UTA': '#002B5C',
            'DEN': '#FEC524', 'LAL': '#552583', 'GSW': '#1D428A', 'PHX': '#E56020',
            'ATL': '#E03A3E', 'BKN': '#FFFFFF', 'HOU': '#CE1141', 'MEM': '#5D76A9',
            'MIL': '#00471B', 'NOP': '#C8102E', 'NYK': '#F58426', 'OKC': '#007AC1',
            'ORL': '#0077C0', 'PHI': '#006BB6', 'POR': '#E03A3E', 'SAC': '#5A2D81',
            'TOR': '#CE1141', 'WAS': '#002B5C'
        };

        // Secondary colors for when primary colors are too similar
        const teamColorsAlt = {
            'MIN': '#0C2340', 'CLE': '#FDBB30', 'BOS': '#BA9653', 'MIA': '#F9A01B',
            'IND': '#FDBB30', 'LAC': '#1D428A', 'DET': '#1D42BA', 'SAS': '#000000',
            'DAL': '#B8C4CA', 'CHI': '#000000', 'CHA': '#00788C', 'UTA': '#F9A01B',
            'DEN': '#0E2240', 'LAL': '#FDB927', 'GSW': '#FFC72C', 'PHX': '#1D1160',
            'ATL': '#C1D32F', 'BKN': '#000000', 'HOU': '#C4CED4', 'MEM': '#12173F',
            'MIL': '#EEE1C6', 'NOP': '#0C2340', 'NYK': '#006BB6', 'OKC': '#EF3B24',
            'ORL': '#000000', 'PHI': '#ED174C', 'POR': '#000000', 'SAC': '#63727A',
            'TOR': '#000000', 'WAS': '#E31837'
        };

        // Check if two colors are too similar
        function colorDistance(hex1, hex2) {
            const r1 = parseInt(hex1.slice(1,3), 16);
            const g1 = parseInt(hex1.slice(3,5), 16);
            const b1 = parseInt(hex1.slice(5,7), 16);
            const r2 = parseInt(hex2.slice(1,3), 16);
            const g2 = parseInt(hex2.slice(3,5), 16);
            const b2 = parseInt(hex2.slice(5,7), 16);
            return Math.sqrt((r2-r1)**2 + (g2-g1)**2 + (b2-b1)**2);
        }

        // Check if a color is dark (for text contrast)
        function isColorDark(hex) {
            const r = parseInt(hex.slice(1,3), 16);
            const g = parseInt(hex.slice(3,5), 16);
            const b = parseInt(hex.slice(5,7), 16);
            // Using relative luminance formula
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance < 0.5;
        }

        // Get team colors, ensuring they're different enough
        function getTeamColors(awayTeam, homeTeam) {
            let awayColor = teamColors[awayTeam] || '#ef4444';
            let homeColor = teamColors[homeTeam] || '#fec524';

            // If colors are too similar (distance < 80), use alternate for away team
            if (colorDistance(awayColor, homeColor) < 80) {
                awayColor = teamColorsAlt[awayTeam] || '#ef4444';
            }

            // If still too similar, use alternate for home team too
            if (colorDistance(awayColor, homeColor) < 80) {
                homeColor = teamColorsAlt[homeTeam] || '#fec524';
            }

            return { awayColor, homeColor };
        }

        function initCharts() {
            // Destroy existing charts
            if (leadChart) { leadChart.destroy(); leadChart = null; }
            if (probChart) { probChart.destroy(); probChart = null; }

            // Reset data including quarter markers
            chartData = { labels: [], homeScores: [], awayScores: [], leadDiffs: [], homeProbs: [], quarterMarkers: [], quarterLabels: [] };
            lastPeriod = 0;

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 },
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(13, 17, 23, 0.9)',
                        titleColor: '#fec524',
                        bodyColor: '#ffffff',
                        borderColor: '#30363d',
                        borderWidth: 1,
                        padding: 8,
                        displayColors: false,
                        titleFont: { family: 'Oswald', size: 11 },
                        bodyFont: { family: 'Roboto', size: 11 }
                    }
                },
                scales: {
                    x: {
                        display: false
                    },
                    y: {
                        ticks: {
                            font: { size: 9 },
                            color: '#6b7280',
                            maxTicksLimit: 5
                        },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            };

            // Lead Differential Chart
            const leadCtx = document.getElementById('leadChart').getContext('2d');
            leadChart = new Chart(leadCtx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        data: chartData.leadDiffs,
                        borderColor: '#fec524',
                        borderWidth: 1.5,
                        fill: {
                            target: { value: 0 },
                            above: 'rgba(134, 0, 56, 0.3)',  // home color
                            below: 'rgba(120, 190, 32, 0.3)'  // away color
                        },
                        tension: 0.2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        pointHoverBackgroundColor: '#fec524'
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            ...chartOptions.plugins.tooltip,
                            callbacks: {
                                title: (items) => {
                                    const idx = items[0]?.dataIndex;
                                    if (idx === undefined) return '';
                                    const home = chartData.homeScores[idx] || 0;
                                    const away = chartData.awayScores[idx] || 0;
                                    return `Score: ${away} - ${home}`;
                                },
                                label: (ctx) => {
                                    const val = ctx.parsed.y;
                                    if (val === 0) return 'Tied';
                                    return val > 0 ? `${currentHomeTeam} +${val}` : `${currentAwayTeam} +${Math.abs(val)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            suggestedMin: -15,
                            suggestedMax: 15,
                            ticks: {
                                ...chartOptions.scales.y.ticks,
                                stepSize: 5,
                                callback: v => v > 0 ? `+${Math.round(v)}` : Math.round(v)
                            },
                            grid: {
                                color: ctx => ctx.tick.value === 0 ? 'rgba(255,255,255,0.4)' : 'rgba(255,255,255,0.1)'
                            }
                        }
                    }
                }
            });

            // Win Probability Chart (100 - EVEN - 100 format, using swing scale: 50% ‚Üí 0, 100% ‚Üí +100, 0% ‚Üí -100)
            const probCtx = document.getElementById('probChart').getContext('2d');
            probChart = new Chart(probCtx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Win Prob',
                        data: chartData.homeProbs,
                        borderColor: '#fec524',
                        borderWidth: 1.5,
                        fill: {
                            target: { value: 0 },
                            above: 'rgba(254, 197, 36, 0.3)',  // home favored (gold)
                            below: 'rgba(239, 68, 68, 0.3)'   // away favored (red)
                        },
                        tension: 0.2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        pointHoverBackgroundColor: '#fec524'
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            min: -100,
                            max: 100,
                            ticks: {
                                font: { size: 8 },
                                color: '#6b7280',
                                stepSize: 50,
                                callback: v => {
                                    if (v === 100) return currentHomeTeam;
                                    if (v === 0) return 'EVEN';
                                    if (v === -100) return currentAwayTeam;
                                    return '';
                                }
                            },
                            grid: {
                                color: ctx => ctx.tick.value === 0 ? 'rgba(255,255,255,0.4)' : 'rgba(255,255,255,0.1)'
                            }
                        }
                    },
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            ...chartOptions.plugins.tooltip,
                            callbacks: {
                                title: (items) => {
                                    const idx = items[0]?.dataIndex;
                                    if (idx === undefined) return '';
                                    const home = chartData.homeScores[idx] || 0;
                                    const away = chartData.awayScores[idx] || 0;
                                    return `Score: ${away} - ${home}`;
                                },
                                label: (ctx) => {
                                    // Convert swing value back to probability
                                    const swingVal = ctx.parsed.y;
                                    const homeProb = Math.round(50 + swingVal / 2);
                                    const awayProb = 100 - homeProb;
                                    return `${currentHomeTeam} ${homeProb}% | ${currentAwayTeam} ${awayProb}%`;
                                }
                            }
                        }
                    }
                }
            });

            // Show charts
            document.getElementById('mini-charts').classList.add('visible');
        }

        // Estimate win probability based on score and game progress
        // Uses a simple model: each point of lead shifts probability, with more impact as game progresses
        function estimateWinProbability(homeScore, awayScore, period) {
            const lead = homeScore - awayScore;

            // Estimate game progress (0-1 scale based on period)
            let gameProgress = 0.25;  // Default to early game
            if (period) {
                if (period <= 4) {
                    gameProgress = period / 4;  // Q1=0.25, Q2=0.5, Q3=0.75, Q4=1.0
                } else {
                    gameProgress = 1.0;  // Overtime
                }
            }

            // Each point shifts probability more as game progresses
            // Early game: ~2% per point, Late game: ~5% per point
            const pointValue = 2 + gameProgress * 3;
            let probAdjust = lead * pointValue;

            // Cap at reasonable bounds (-45 to +45 around 50%)
            probAdjust = Math.max(-45, Math.min(45, probAdjust));

            return 50 + probAdjust;
        }

        function updateCharts(homeScore, awayScore, homeTeam, awayTeam, homeProb = null, period = null) {
            if (!leadChart || !probChart) return;

            // Check for quarter change - add marker at start of each quarter
            if (period && period > lastPeriod) {
                const markerIndex = chartData.labels.length;  // Current position before adding
                chartData.quarterMarkers.push(markerIndex);
                chartData.quarterLabels.push(period <= 4 ? `Q${period}` : `OT${period - 4}`);
                lastPeriod = period;
            }

            // Add data point
            const label = chartData.labels.length;
            chartData.labels.push(label);
            chartData.homeScores.push(homeScore);
            chartData.awayScores.push(awayScore);
            chartData.leadDiffs.push(homeScore - awayScore);

            // Add probability data point (convert to swing scale: 50% ‚Üí 0, 100% ‚Üí +100, 0% ‚Üí -100)
            let prob;
            if (homeProb !== null) {
                prob = homeProb;
            } else {
                // Estimate win probability based on score differential and game progress
                prob = estimateWinProbability(homeScore, awayScore, period);
            }
            const swingValue = (prob - 50) * 2;  // 50% ‚Üí 0, 75% ‚Üí +50, 25% ‚Üí -50
            chartData.homeProbs.push(swingValue);

            // Limit data points for performance (keep last 100)
            const maxPoints = 100;
            if (chartData.labels.length > maxPoints) {
                chartData.labels.shift();
                chartData.homeScores.shift();
                chartData.awayScores.shift();
                chartData.leadDiffs.shift();
                chartData.homeProbs.shift();

                // Adjust quarter markers when data shifts (decrement all indices by 1)
                // Filter both markers and labels together
                const newMarkers = [];
                const newLabels = [];
                for (let i = 0; i < chartData.quarterMarkers.length; i++) {
                    const newIdx = chartData.quarterMarkers[i] - 1;
                    if (newIdx >= 0) {
                        newMarkers.push(newIdx);
                        newLabels.push(chartData.quarterLabels[i]);
                    }
                }
                chartData.quarterMarkers = newMarkers;
                chartData.quarterLabels = newLabels;
            }

            // Update team colors in charts (use contrasting colors)
            const { awayColor, homeColor } = getTeamColors(awayTeam, homeTeam);

            // Update lead chart fill colors
            leadChart.data.datasets[0].fill.above = homeColor + '4D';  // 30% opacity
            leadChart.data.datasets[0].fill.below = awayColor + '4D';

            // Sync chart data arrays with chartData (Chart.js needs direct reference updates)
            leadChart.data.labels = chartData.labels;
            leadChart.data.datasets[0].data = chartData.leadDiffs;
            probChart.data.labels = chartData.labels;
            probChart.data.datasets[0].data = chartData.homeProbs;

            // Update chart display
            leadChart.update('none');
            probChart.update('none');
        }

        function formatMoneyline(ml) {
            if (ml === null || ml === undefined) return '--';
            return ml > 0 ? `+${ml}` : ml.toString();
        }

        function updateOddsDisplay(odds, homeTeam, awayTeam, homeCity = null, awayCity = null) {
            const oddsSection = document.getElementById('odds-section');
            if (!odds || !odds.consensus) {
                oddsSection.classList.remove('visible');
                return;
            }

            oddsSection.classList.add('visible');
            currentOdds = odds;

            const consensus = odds.consensus;
            // Get colors that are different enough to distinguish
            const { awayColor, homeColor } = getTeamColors(awayTeam, homeTeam);

            // Use city names if available, fallback to abbreviations
            const homeDisplay = homeCity || homeTeam;
            const awayDisplay = awayCity || awayTeam;

            // Update spread (show which team is favored)
            const spreadEl = document.getElementById('odds-spread');
            if (consensus.spread !== null && consensus.spread !== undefined) {
                const spreadVal = consensus.spread;
                const favoredDisplay = spreadVal < 0 ? homeDisplay : awayDisplay;
                const spreadDisplay = Math.abs(spreadVal);
                spreadEl.innerHTML = `<span class="team-abbrev">${favoredDisplay}</span> -${spreadDisplay}`;
            } else {
                spreadEl.textContent = '--';
            }

            // Update total
            const totalEl = document.getElementById('odds-total');
            totalEl.textContent = consensus.total ? `O/U ${consensus.total}` : '--';

            // Update moneylines (use city names)
            const awayMl = consensus.away_ml;
            const homeMl = consensus.home_ml;
            document.getElementById('ml-away-abbrev').textContent = awayDisplay;
            document.getElementById('ml-home-abbrev').textContent = homeDisplay;

            const awayMlEl = document.getElementById('ml-away-value');
            const homeMlEl = document.getElementById('ml-home-value');
            awayMlEl.textContent = formatMoneyline(awayMl);
            homeMlEl.textContent = formatMoneyline(homeMl);

            // Style favorite vs underdog
            if (awayMl !== null && homeMl !== null) {
                awayMlEl.className = 'ml-value ' + (awayMl < homeMl ? 'favorite' : 'underdog');
                homeMlEl.className = 'ml-value ' + (homeMl < awayMl ? 'favorite' : 'underdog');
            }

            // Update probability display with team colors
            const homeProb = consensus.home_prob || 50;
            const awayProb = consensus.away_prob || 50;

            // Normalize to 100% total (remove vig)
            const totalProb = homeProb + awayProb;
            const normalizedHomeProb = Math.round((homeProb / totalProb) * 100);
            const normalizedAwayProb = 100 - normalizedHomeProb;

            // Update probability bar with team colors and proper text contrast
            const awayBar = document.getElementById('away-prob-bar');
            const homeBar = document.getElementById('home-prob-bar');

            awayBar.style.width = `${normalizedAwayProb}%`;
            awayBar.style.background = awayColor;
            awayBar.style.color = isColorDark(awayColor) ? '#ffffff' : '#0d1117';
            awayBar.textContent = normalizedAwayProb >= 20 ? `${normalizedAwayProb}%` : '';

            homeBar.style.width = `${normalizedHomeProb}%`;
            homeBar.style.background = homeColor;
            homeBar.style.color = isColorDark(homeColor) ? '#ffffff' : '#0d1117';
            homeBar.textContent = normalizedHomeProb >= 20 ? `${normalizedHomeProb}%` : '';

            // Update labels with team colors (use city names)
            document.getElementById('away-dot').style.background = awayColor;
            document.getElementById('home-dot').style.background = homeColor;
            document.getElementById('away-prob-text').textContent = `${awayDisplay} ${normalizedAwayProb}%`;
            document.getElementById('home-prob-text').textContent = `${homeDisplay} ${normalizedHomeProb}%`;

            // Update vendor count
            document.getElementById('odds-vendor-count').textContent =
                consensus.vendor_count ? `Consensus from ${consensus.vendor_count} bookmakers` : '';
        }

        // Track active filters (all active by default)
        let activeFilters = new Set(['play_by_play', 'stats_nerd', 'hype_man', 'historian', 'ai_commentator']);

        function toggleFilter(botType) {
            if (activeFilters.has(botType)) {
                activeFilters.delete(botType);
            } else {
                activeFilters.add(botType);
            }
            applyFilters();
        }

        function applyFilters() {
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const bot = btn.dataset.bot;
                btn.classList.toggle('active', activeFilters.has(bot));
            });

            // Filter existing messages
            document.querySelectorAll('.chat-message').forEach(msg => {
                const botType = Array.from(msg.classList)
                    .find(c => c.startsWith('bot-'))
                    ?.replace('bot-', '');
                if (botType) {
                    msg.classList.toggle('filtered', !activeFilters.has(botType));
                }
            });
        }

        // Update box score display
        function updateBoxScore(stats) {
            playerStats = stats || { home: [], away: [] };

            // Update toggle button labels with team names
            document.getElementById('toggle-away').textContent = currentAwayTeam;
            document.getElementById('toggle-home').textContent = currentHomeTeam;

            // Show box score section if we have any stats
            const hasStats = playerStats.home.length > 0 || playerStats.away.length > 0;
            document.getElementById('box-score-section').classList.toggle('visible', hasStats);

            // Render current team's stats
            renderPlayerStats(currentStatsTeam);
        }

        function renderPlayerStats(team) {
            const players = playerStats[team] || [];
            const tbody = document.getElementById('player-stats-body');

            if (players.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 20px; color: var(--text-muted);">No player stats yet</td></tr>';
                return;
            }

            // Calculate totals
            const totals = { pts: 0, reb: 0, ast: 0, stl: 0, blk: 0, fgm: 0, fga: 0, fg3m: 0, ftm: 0, fta: 0 };

            let html = '';
            players.forEach(p => {
                const fgPct = p.fga > 0 ? (p.fgm / p.fga * 100).toFixed(1) : '0.0';
                const ptsClass = p.pts >= 20 ? 'highlight' : '';

                html += `<tr>
                    <td class="player-col">${p.name}</td>
                    <td class="${ptsClass}">${p.pts}</td>
                    <td>${p.reb}</td>
                    <td>${p.ast}</td>
                    <td>${p.stl}</td>
                    <td>${p.blk}</td>
                    <td>${p.fgm}</td>
                    <td>${p.fga}</td>
                    <td class="pct">${fgPct}</td>
                    <td>${p.fg3m}</td>
                    <td>${p.ftm}</td>
                    <td>${p.fta}</td>
                </tr>`;

                // Add to totals
                totals.pts += p.pts || 0;
                totals.reb += p.reb || 0;
                totals.ast += p.ast || 0;
                totals.stl += p.stl || 0;
                totals.blk += p.blk || 0;
                totals.fgm += p.fgm || 0;
                totals.fga += p.fga || 0;
                totals.fg3m += p.fg3m || 0;
                totals.ftm += p.ftm || 0;
                totals.fta += p.fta || 0;
            });

            // Add totals row
            const totalFgPct = totals.fga > 0 ? (totals.fgm / totals.fga * 100).toFixed(1) : '0.0';
            html += `<tr class="totals-row">
                <td class="player-col">TOTAL</td>
                <td>${totals.pts}</td>
                <td>${totals.reb}</td>
                <td>${totals.ast}</td>
                <td>${totals.stl}</td>
                <td>${totals.blk}</td>
                <td>${totals.fgm}</td>
                <td>${totals.fga}</td>
                <td class="pct">${totalFgPct}</td>
                <td>${totals.fg3m}</td>
                <td>${totals.ftm}</td>
                <td>${totals.fta}</td>
            </tr>`;

            tbody.innerHTML = html;
        }

        function switchTeamStats(team) {
            currentStatsTeam = team;

            // Update toggle buttons
            document.getElementById('toggle-away').classList.toggle('active', team === 'away');
            document.getElementById('toggle-home').classList.toggle('active', team === 'home');

            // Re-render stats
            renderPlayerStats(team);
        }

        // Format UTC time to local time
        function formatLocalTime(utcTimeStr) {
            if (!utcTimeStr) return null;
            try {
                const date = new Date(utcTimeStr);
                return date.toLocaleTimeString([], {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            } catch (e) {
                return null;
            }
        }

        // Get game status text with local time
        function getGameStatusText(game) {
            // For live or finished games, use the status as-is
            if (game.status === 'Final' || game.status === 'Final (Saved)' ||
                game.status.includes('Q') || game.status === 'Half' ||
                game.status.includes('OT')) {
                return game.status;
            }

            // For upcoming games, check if it's about to start (within 30 minutes)
            if (game.game_time_utc) {
                try {
                    const gameTime = new Date(game.game_time_utc);
                    const now = new Date();
                    const minutesUntilGame = (gameTime - now) / 60000;

                    // If within 30 minutes of start or just past start time, show "Pregame"
                    if (minutesUntilGame <= 30 && minutesUntilGame > -10) {
                        const localTime = formatLocalTime(game.game_time_utc);
                        return `Pregame (${localTime})`;
                    }
                } catch (e) {
                    // Ignore parsing errors
                }
            }

            // For upcoming games, convert to local time
            const localTime = formatLocalTime(game.game_time_utc);
            if (localTime) {
                return localTime;
            }

            // Fallback to original status
            return game.status;
        }

        async function loadGames() {
            try {
                const response = await fetch('/api/dev-live/games');
                const data = await response.json();

                const select = document.getElementById('game-select');
                select.innerHTML = '<option value="">-- Select a game --</option>';

                // Reset games data store
                gamesData = {};

                if (data.games && data.games.length > 0) {
                    data.games.forEach(game => {
                        // Store game data for later access
                        gamesData[game.game_id] = game;

                        const option = document.createElement('option');
                        option.value = game.game_id;
                        const statusText = getGameStatusText(game);
                        // Use full team names: "Miami Heat @ Indiana Pacers"
                        const awayFull = `${game.away_team_city} ${game.away_team_name}`;
                        const homeFull = `${game.home_team_city} ${game.home_team_name}`;
                        let text = `${awayFull} @ ${homeFull} - ${statusText}`;
                        if (game.status.includes('Q') || game.status === 'Half') {
                            text += ` (${game.away_score}-${game.home_score})`;
                        } else if (game.status === 'Final' || game.status === 'Final (Saved)') {
                            text += ` (${game.away_score}-${game.home_score})`;
                        }
                        // Add history indicator
                        if (game.has_history) {
                            text += ' üìú';
                        }
                        option.textContent = text;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No games available</option>';
                }

                // Check URL for game parameter and auto-select
                const urlParams = new URLSearchParams(window.location.search);
                const gameFromUrl = urlParams.get('game');
                if (gameFromUrl && gamesData[gameFromUrl]) {
                    select.value = gameFromUrl;
                    selectGame(gameFromUrl, false);  // Don't update URL again
                }
            } catch (error) {
                console.error('Error loading games:', error);
                document.getElementById('game-select').innerHTML = '<option value="">Error loading games</option>';
            }
        }

        function selectGame(gameId, updateUrl = true) {
            if (!gameId) {
                document.getElementById('scoreboard').style.display = 'none';
                document.getElementById('chat-container').style.display = 'none';
                document.getElementById('mini-charts').classList.remove('visible');
                document.getElementById('odds-section').classList.remove('visible');
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                }
                // Clear URL parameter
                if (updateUrl) {
                    window.history.replaceState({}, '', '/dev-live');
                }
                return;
            }

            currentGameId = gameId;

            // Update URL with game ID (allows refresh and sharing)
            if (updateUrl) {
                window.history.replaceState({}, '', `/dev-live?game=${gameId}`);
            }
            lastActionNumber = 0;

            document.getElementById('scoreboard').style.display = 'flex';
            document.getElementById('chat-container').style.display = 'block';
            document.getElementById('chat-feed').innerHTML = '<div class="loading" id="loading"><div class="spinner"></div><p>Loading game feed...</p></div>';

            // Get game data from stored games
            const gameData = gamesData[gameId];

            // Update scoreboard immediately from stored data
            if (gameData) {
                // Show city names in scoreboard
                document.getElementById('home-team').textContent = gameData.home_team_city || gameData.home_team;
                document.getElementById('away-team').textContent = gameData.away_team_city || gameData.away_team;
                document.getElementById('home-score').textContent = gameData.home_score || 0;
                document.getElementById('away-score').textContent = gameData.away_score || 0;

                // Set team names for chart labels (use abbreviations for compactness)
                currentHomeTeam = gameData.home_team || 'HOME';
                currentAwayTeam = gameData.away_team || 'AWAY';

                // Display odds if available (pass both abbrev and city for display flexibility)
                if (gameData.odds) {
                    updateOddsDisplay(gameData.odds, gameData.home_team, gameData.away_team, gameData.home_team_city, gameData.away_team_city);
                } else {
                    document.getElementById('odds-section').classList.remove('visible');
                }
            }

            // Initialize charts (will use currentHomeTeam/currentAwayTeam for labels)
            initCharts();

            // Start polling
            fetchFeed();
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(fetchFeed, 5000); // Poll every 5 seconds
        }

        async function fetchFeed() {
            if (!currentGameId) return;

            try {
                const response = await fetch(`/api/dev-live/feed/${currentGameId}?last_action=${lastActionNumber}&client_id=${clientId}`);
                const data = await response.json();

                if (data.error) {
                    console.error('Feed error:', data.error);
                    return;
                }

                // Check if this is historical data (completed game)
                if (data.is_historical) {
                    // Stop polling for completed games
                    if (pollInterval) {
                        clearInterval(pollInterval);
                        pollInterval = null;
                    }
                }

                // Update scoreboard (use city names from stored game data)
                const storedGame = gamesData[currentGameId];
                const homeCity = storedGame?.home_team_city || data.game_info?.home_team;
                const awayCity = storedGame?.away_team_city || data.game_info?.away_team;

                if (data.game_info) {
                    document.getElementById('home-team').textContent = homeCity;
                    document.getElementById('away-team').textContent = awayCity;
                }
                if (data.score) {
                    document.getElementById('home-score').textContent = data.score.home;
                    document.getElementById('away-score').textContent = data.score.away;
                    // Update header score with city names
                    let scoreText = `${awayCity} ${data.score.away} - ${homeCity} ${data.score.home}`;
                    if (data.status === 'Final') {
                        scoreText += ' (FINAL)';
                    } else if (data.is_pregame) {
                        scoreText = `${awayCity} @ ${homeCity} (PREGAME)`;
                    }
                    document.getElementById('stat-score').textContent = scoreText;

                    // Load score history for charts (historical games OR first load of live game)
                    if ((data.is_historical || data.is_first_load) && data.scores && data.scores.length > 0) {
                        // Reconstruct charts from saved score history (with period info for quarter lines)
                        data.scores.forEach(s => {
                            updateCharts(s.home, s.away, data.game_info.home_team, data.game_info.away_team, null, s.period);
                        });
                    } else {
                        // Live update - pass current period for quarter tracking
                        const currentPeriod = data.period || null;
                        updateCharts(data.score.home, data.score.away, data.game_info.home_team, data.game_info.away_team, null, currentPeriod);
                    }
                }

                // Update box score with player stats
                if (data.player_stats) {
                    updateBoxScore(data.player_stats);
                }

                // Update stats in header
                document.getElementById('stat-lead-changes').textContent = `üîÑ ${data.lead_changes || 0}`;
                // Show appropriate status based on game state
                if (data.is_historical) {
                    document.getElementById('stat-viewers').textContent = 'üì∫ Replay';
                } else if (data.is_pregame) {
                    document.getElementById('stat-viewers').textContent = '‚è∞ Starting Soon';
                } else {
                    document.getElementById('stat-viewers').textContent = `üëÅ ${data.viewer_count || 1}`;
                }

                // Update last action number (handle pregame with negative action numbers)
                if (data.last_action > lastActionNumber || (data.is_pregame && lastActionNumber === 0)) {
                    lastActionNumber = data.last_action;
                }

                // Add new messages (but don't re-add pregame messages we already have)
                if (data.messages && data.messages.length > 0 && !(data.is_pregame && lastActionNumber < 0 && document.querySelectorAll('.chat-message').length > 0)) {
                    const feed = document.getElementById('chat-feed');
                    const loading = document.getElementById('loading');
                    if (loading) loading.remove();

                    data.messages.forEach(msg => {
                        const msgEl = createMessageElement(msg);
                        feed.appendChild(msgEl);
                    });

                    // Auto-scroll to bottom
                    feed.scrollTop = feed.scrollHeight;
                }

                // Handle empty feed for completed games with no saved messages
                if (data.is_historical && (!data.messages || data.messages.length === 0)) {
                    const feed = document.getElementById('chat-feed');
                    const loading = document.getElementById('loading');
                    if (loading) {
                        loading.innerHTML = '<p>No chat history available for this game.</p>';
                    }
                }

            } catch (error) {
                console.error('Error fetching feed:', error);
            }
        }

        function createMessageElement(msg) {
            const div = document.createElement('div');
            div.className = `chat-message bot-${msg.bot}`;
            if (msg.team) div.classList.add(`team-${msg.team}`);

            // Apply filter immediately if this bot is filtered out
            if (!activeFilters.has(msg.bot)) {
                div.classList.add('filtered');
            }

            const emoji = botEmojis[msg.bot] || '&#x1F4AC;';
            const botName = botNames[msg.bot] || msg.bot;
            // Show "PRE-GAME" for pregame messages (negative action numbers), otherwise show quarter/clock
            const time = (msg.action_number < 0) ? 'PRE-GAME' : (msg.clock ? `Q${msg.period} ${msg.clock}` : '');

            div.innerHTML = `
                <div class="msg-avatar">${emoji}</div>
                <div class="msg-content">
                    <div class="msg-header">
                        <span class="msg-bot-name bot-${msg.bot}">${botName}</span>
                        <span class="msg-time">${time}</span>
                    </div>
                    <div class="msg-text">${msg.text}</div>
                    <div class="msg-score">${msg.score}</div>
                </div>
            `;

            return div;
        }

        // Initialize
        document.getElementById('game-select').addEventListener('change', (e) => {
            selectGame(e.target.value);
        });

        // Filter button click handlers
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                toggleFilter(btn.dataset.bot);
            });
        });

        // Team toggle button click handlers
        document.querySelectorAll('.team-toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                switchTeamStats(btn.dataset.team);
            });
        });

        // Display user's timezone
        function getTimezoneAbbreviation() {
            const date = new Date();
            const timeStr = date.toLocaleTimeString('en-US', { timeZoneName: 'short' });
            // Extract timezone abbreviation (e.g., "MST", "EST", "PST")
            const match = timeStr.match(/[A-Z]{2,5}$/);
            return match ? match[0] : Intl.DateTimeFormat().resolvedOptions().timeZone;
        }
        document.getElementById('timezone-label').textContent = `(${getTimezoneAbbreviation()})`;

        loadGames();

        // Refresh game list every 60 seconds
        setInterval(loadGames, 60000);
    </script>
</body>
</html>
